<!DOCTYPE html>  <html> <head>   <title>app.js.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               app.js.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span> <span class="nf">-&gt;</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">r = </span>
    <span class="nv">cellReferenceMatchAll: </span> <span class="sr">/([A-Z]+[1-9]+[0-9]*|time)/g</span> 

  <span class="nb">window</span><span class="p">.</span><span class="nv">f = </span>
    <span class="nv">isNumber: </span><span class="nf">(string) -&gt;</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">isInteger</span><span class="p">(</span><span class="nx">string</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nv">isInteger: </span><span class="nf">(string) -&gt;</span>
      <span class="nb">parseInt</span><span class="p">(</span><span class="nx">string</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span> <span class="o">==</span> <span class="nx">string</span>
    <span class="nv">getInputValue: </span><span class="nf">(input) -&gt;</span>
      <span class="nv">input = </span><span class="nx">input</span><span class="p">.</span><span class="nx">currentTarget</span> <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">currentTarget</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">input</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="nv">isEquation: </span><span class="nf">(string) -&gt;</span>
      <span class="nx">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;=&quot;</span>
    <span class="nv">isntEquation: </span><span class="nf">(string) -&gt;</span> <span class="o">!</span><span class="nx">f</span><span class="p">.</span><span class="nx">isEquation</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
    <span class="nv">findCellReferencesInEquation: </span><span class="nf">(equation) -&gt;</span>
      <span class="nx">equation</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">cellReferenceMatchAll</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]</span>
    <span class="nv">replaceVariablesInEquation: </span><span class="nf">(equation) -&gt;</span>
      <span class="nv">equation = </span><span class="nx">equation</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="nv">lastReplace = </span><span class="o">-</span><span class="mi">1</span>
      <span class="nx">equation</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">cellReferenceMatchAll</span><span class="p">,</span> <span class="nf">-&gt;</span>
        <span class="nx">lastReplace</span><span class="o">++</span>
        <span class="k">return</span> <span class="s">&quot;args[</span><span class="si">#{</span><span class="nx">lastReplace</span><span class="si">}</span><span class="s">]&quot;</span>
      <span class="p">)</span>
    <span class="nv">applyOrderedArgsToEquation: </span><span class="nf">(args, equation) -&gt;</span>
      <span class="nv">equation = </span><span class="nx">f</span><span class="p">.</span><span class="nx">replaceVariablesInEquation</span><span class="p">(</span><span class="nx">equation</span><span class="p">)</span>
      <span class="nb">eval</span><span class="p">(</span><span class="nx">equation</span><span class="p">)</span>
    <span class="nv">coerceFieldValue: </span><span class="nf">(value) -&gt;</span>
      <span class="nv">value = </span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isInteger</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
          <span class="nb">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">value</span>
    <span class="nv">incrementCellReference: </span><span class="nf">(cellRef, dir) -&gt;</span>
      <span class="nv">cellRef = </span><span class="nx">cellRef</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/^[A-Z]/</span><span class="p">,</span> <span class="nf">(alpha) -&gt;</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">alpha</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nx">dir</span> <span class="o">==</span> <span class="s">&quot;left&quot;</span> <span class="o">and</span> <span class="nx">alpha</span> <span class="o">!=</span> <span class="s">&quot;A&quot;</span>
        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">alpha</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nx">dir</span> <span class="o">==</span> <span class="s">&quot;right&quot;</span>
        <span class="k">return</span> <span class="nx">alpha</span>

      <span class="nv">cellRef = </span><span class="nx">cellRef</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/[0-9]+$/</span><span class="p">,</span> <span class="nf">(n) -&gt;</span>
        <span class="nv">n = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nx">dir</span> <span class="o">==</span> <span class="s">&quot;up&quot;</span> <span class="o">and</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nx">dir</span> <span class="o">==</span> <span class="s">&quot;down&quot;</span>
        <span class="k">return</span> <span class="nx">n</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Motion management, with arrow keys/return</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">keyMap = </span><span class="p">{</span>
    <span class="mi">38</span><span class="o">:</span> <span class="s">&quot;up&quot;</span><span class="p">,</span> <span class="c1">#up arrow</span>
    <span class="mi">40</span><span class="o">:</span> <span class="s">&quot;down&quot;</span><span class="p">,</span> <span class="c1">#down arrow</span>
    <span class="mi">13</span><span class="o">:</span> <span class="s">&quot;down&quot;</span><span class="p">,</span> <span class="c1">#enter key</span>
  <span class="p">}</span>
  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;td input&#39;</span><span class="p">).</span><span class="nx">asEventStream</span><span class="p">(</span><span class="s">&#39;keyup&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="nf">(ev) -&gt;</span>
                  <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="nx">keyMap</span><span class="p">).</span><span class="nx">keys</span><span class="p">().</span><span class="nx">contains</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">.</span><span class="nx">toString</span><span class="p">()).</span><span class="nx">value</span><span class="p">()</span>
                  
                <span class="p">)</span>
                <span class="p">.</span><span class="nx">onValue</span><span class="p">(</span> <span class="nf">(ev) -&gt;</span>
                  <span class="nv">dir = </span><span class="nx">keyMap</span><span class="p">[</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">keyCode</span> <span class="p">]</span>
                  <span class="nv">currentRef = </span><span class="nx">$</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&quot;reference&quot;</span><span class="p">)</span>
                  <span class="nv">newRef = </span><span class="nx">f</span><span class="p">.</span><span class="nx">incrementCellReference</span><span class="p">(</span><span class="nx">currentRef</span><span class="p">,</span> <span class="nx">dir</span><span class="p">)</span>
                  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[data-reference=</span><span class="si">#{</span><span class="nx">newRef</span><span class="si">}</span><span class="s">]&quot;</span><span class="p">).</span><span class="nx">focus</span><span class="p">()</span>
                <span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Equation management</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">window</span><span class="p">.</span><span class="nv">inputStreams = </span><span class="p">{}</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">valueStreams = </span><span class="p">{}</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">valueProperties = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Time stream</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">valueProperties.time = </span><span class="nx">Bacon</span><span class="p">.</span><span class="nx">fromPoll</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nf">(v) -&gt;</span>
    <span class="k">new</span> <span class="nx">Bacon</span><span class="p">.</span><span class="nx">Next</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">())</span>
  <span class="p">).</span><span class="nx">toProperty</span><span class="p">()</span>


  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;td input&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">-&gt;</span>
    <span class="nv">$cell = </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nv">$result = </span><span class="nx">$cell</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s">&#39;td&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;div.result&#39;</span><span class="p">)</span>

    <span class="nv">reference = </span><span class="nx">$cell</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;reference&#39;</span><span class="p">)</span>
    <span class="nv">inputStream = </span><span class="nx">$cell</span><span class="p">.</span><span class="nx">asEventStream</span><span class="p">(</span><span class="s">&#39;change&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">getInputValue</span><span class="p">).</span><span class="nx">toProperty</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="nv">valueStream = </span><span class="k">new</span> <span class="nx">Bacon</span><span class="p">.</span><span class="nx">Bus</span><span class="p">()</span>
    <span class="nv">valueProperty = </span><span class="nx">valueStream</span><span class="p">.</span><span class="nx">toProperty</span><span class="p">()</span>

    <span class="nx">inputStreams</span><span class="p">[</span><span class="nx">reference</span><span class="p">]</span> <span class="o">=</span> <span class="nx">inputStream</span>
    <span class="nx">valueStreams</span><span class="p">[</span><span class="nx">reference</span><span class="p">]</span> <span class="o">=</span> <span class="nx">valueStream</span>
    <span class="nx">valueProperties</span><span class="p">[</span><span class="nx">reference</span><span class="p">]</span> <span class="o">=</span> <span class="nx">valueProperty</span>
    
    <span class="nx">inputStream</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">isEquation</span><span class="p">).</span><span class="nx">onValue</span> <span class="nf">(equation) -&gt;</span>
      <span class="nv">cellRefs = </span><span class="nx">f</span><span class="p">.</span><span class="nx">findCellReferencesInEquation</span><span class="p">(</span><span class="nx">equation</span><span class="p">)</span>

      <span class="k">if</span> <span class="nx">cellRefs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">result = </span><span class="nx">valueProperties</span><span class="p">[</span> <span class="nx">cellRefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">].</span><span class="nx">map</span><span class="p">(</span> <span class="nf">(v) -&gt;</span> <span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="p">)</span>

        <span class="k">for</span> <span class="nx">cellRef</span> <span class="k">in</span> <span class="nx">cellRefs</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
          <span class="nv">stream = </span><span class="nx">valueProperties</span><span class="p">[</span> <span class="nx">cellRef</span> <span class="p">]</span>
          <span class="nv">result = </span><span class="nx">result</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nf">(arr, v) -&gt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span> <span class="nx">arr</span><span class="p">)</span>

        <span class="nv">result = </span><span class="nx">result</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nf">(args) -&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">applyOrderedArgsToEquation</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">equation</span><span class="p">))</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">onValue</span><span class="p">(</span> <span class="nf">(value) -&gt;</span> <span class="nx">valueStream</span><span class="p">.</span><span class="nx">push</span> <span class="nx">value</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">valueStream</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span><span class="p">.</span><span class="nx">applyOrderedArgsToEquation</span><span class="p">([],</span> <span class="nx">equation</span><span class="p">)</span>

    <span class="nx">inputStream</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">isntEquation</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">coerceFieldValue</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">onValue</span><span class="p">(</span><span class="nf">(value) -&gt;</span> <span class="nx">valueStream</span><span class="p">.</span><span class="nx">push</span> <span class="nx">value</span><span class="p">)</span>

    <span class="nx">valueProperty</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nf">(v) -&gt;</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">))).</span><span class="nx">assign</span> <span class="nx">$result</span><span class="p">,</span> <span class="s">&quot;text&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 